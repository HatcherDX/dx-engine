name: CI

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.6.1'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.14.0'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run linter
        run: pnpm run lint

      - name: Run build
        run: pnpm run build

  # Fast unit tests with mocks (runs on every push)
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.6.1'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.14.0'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm run build

      - name: Run unit tests with coverage (mocked)
        run: pnpm test:coverage:ci

      - name: Upload unit test coverage
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage-reports
          path: coverage/

  # Integration tests disabled in CI - require native dependencies
  # These tests should be run locally during development
  # integration-tests job removed to save CI resources

  # Combined coverage report (runs only on main branch)
  test-coverage:
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.6.1'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.14.0'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm run build

      - name: Run all tests with coverage
        run: pnpm test:coverage:ci

      - name: Verify coverage reports exist
        run: |
          echo "📊 Checking coverage reports..."

          if [ -f "coverage/coverage-summary.json" ]; then
            echo "✅ Coverage report found"
            echo "Coverage Summary:"
            cat coverage/coverage-summary.json | head -20
          else
            echo "❌ Coverage summary not found"
            ls -la coverage/ || echo "Coverage directory does not exist"
          fi

      - name: Upload combined coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: combined-coverage-reports
          path: coverage/

      - name: Upload coverage to repository
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Create coverage branch if it doesn't exist
          git checkout -B coverage-reports

          # Copy coverage files to root for easy access
          if [ -f "coverage/unit/coverage-summary.json" ]; then
            cp coverage/unit/coverage-summary.json unit-coverage-summary.json
          fi
          if [ -f "coverage/integration/coverage-summary.json" ]; then
            cp coverage/integration/coverage-summary.json integration-coverage-summary.json
          fi

          # Add and commit coverage files (force add ignored files)
          git add -f coverage/
          git add *coverage-summary.json 2>/dev/null || true

          # Only commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "📊 Update coverage reports (unit + integration) [skip ci]"
            git push origin coverage-reports --force
          fi

  format-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.6.1'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.14.0'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Check formatting
        run: pnpm run format:check
